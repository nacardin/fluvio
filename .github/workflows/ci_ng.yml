name: CI NG

on:
  push:
    branches: [ci_ng]
  workflow_dispatch:

jobs:
  cancel_previous_runs:
    name: Cancel Previous Runs
    runs-on: ubuntu-latest
    steps:
    - uses: styfle/cancel-workflow-action@0.4.1
      with:
        access_token: ${{ secrets.GITHUB_TOKEN }}

  megatest:
    name: Megatest
    runs-on: ubuntu-20.04
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-2
      AWS_DEFAULT_REGION: us-east-2
      EC2_AMI: ami-0a3bb968cc36aa314
    steps:
    - run: curl -sSf https://raw.githubusercontent.com/$GITHUB_REPOSITORY/$GITHUB_SHA/ci_ng.sh | bash -xe
    - run: $SSH_EXEC 'echo test'
    - run: $SSH_EXEC 'git clone https://github.com/infinyon/fluvio.git --depth 1'
    - if: always()
      run: aws ec2 terminate-instances --instance-ids $(cat ec2_instance_id)